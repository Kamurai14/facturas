@page "/reporte"
@using facturas.Components.Data
@using facturas.Components.Servicios
@rendermode InteractiveServer
@inject ServicioControlador ServicioControlador

<PageTitle>Reporte Anual</PageTitle>

<div class="warm-layout">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="fw-bold mb-1">Reporte Anual</h1>
            <p class="text-muted mb-0">Análisis de ventas y desglose mensual.</p>
        </div>
    </div>

    <div class="warm-card mb-5">
        <div class="row align-items-end">
            <div class="col-md-4">
                <label for="anioInput" class="stat-label">Año Fiscal</label>
                <input type="number" id="anioInput" class="form-control" @bind="anioSeleccionado" />
            </div>
            <div class="col-md-3">
                <button class="btn btn-primary w-100" @onclick="GenerarReporte">
                    Generar Reporte
                </button>
            </div>
        </div>
    </div>

    @if (datosReporte != null)
    {
        @if (datosReporte.Any())
        {
            <div class="row">
                <div class="col-md-5 mb-4">
                    <h4 class="mb-3">Resumen @anioSeleccionado</h4>
                    <div class="warm-card p-0 overflow-hidden">
                        <table class="table table-hover mb-0">
                            <thead style="background-color: #faf9f8;">
                                <tr>
                                    <th class="ps-4 border-bottom-0 text-muted small text-uppercase">Mes</th>
                                    <th class="pe-4 text-end border-bottom-0 text-muted small text-uppercase">Facturado</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in datosReporte)
                                {
                                    <tr>
                                        <td class="ps-4 py-3">@item.NombreMes</td>
                                        <td class="pe-4 py-3 text-end fw-bold">@item.TotalMes.ToString("C")</td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot style="background-color: #fff8f5;">
                                <tr>
                                    <td class="ps-4 py-3 fw-bold">TOTAL ANUAL</td>
                                    <td class="pe-4 py-3 text-end fs-4 fw-bold" style="color: var(--primary-warm);">@totalAnual.ToString("C")</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <div class="col-md-7">
                    @if (facturasDelAnio != null && facturasDelAnio.Any())
                    {
                        <h4 class="mb-3">Detalle de Operaciones</h4>
                        <div class="warm-card p-0 overflow-hidden">
                            <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                                <table class="table table-sm mb-0">
                                    <thead style="background-color: #faf9f8; position: sticky; top: 0;">
                                        <tr>
                                            <th class="ps-4 py-3 text-muted small">ID</th>
                                            <th class="py-3 text-muted small">Fecha</th>
                                            <th class="py-3 text-muted small">Cliente</th>
                                            <th class="pe-4 py-3 text-end text-muted small">Monto</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var fact in facturasDelAnio)
                                        {
                                            <tr>
                                                <td class="ps-4 text-muted">@fact.FacturaID</td>
                                                <td>@fact.Fecha.ToShortDateString()</td>
                                                <td>@fact.Nombre</td>
                                                <td class="pe-4 text-end">@fact.TotalFactura.ToString("C")</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
        else
        {
            <div class="warm-card text-center py-5">
                <p class="text-muted mb-0">No se encontraron registros de ventas para el año <strong>@anioSeleccionado</strong>.</p>
            </div>
        }
    }
    else if (!string.IsNullOrEmpty(mensajeError))
    {
        <div class="alert alert-danger border-0 bg-danger bg-opacity-10 text-danger rounded-3 mt-4">
            @mensajeError
        </div>
    }
</div>

@code {
    private int anioSeleccionado = DateTime.Now.Year;
    private List<ReporteMensual>? datosReporte;
    private List<Factura>? facturasDelAnio;
    private decimal totalAnual;
    private string mensajeError = string.Empty;

    private async Task GenerarReporte()
    {
        mensajeError = string.Empty;
        datosReporte = null;
        facturasDelAnio = null;
        totalAnual = 0;

        try
        {
            var reporteTask = ServicioControlador.ObtenerReporteAnualAsync(anioSeleccionado);
            var facturasTask = ServicioControlador.ObtenerFacturasPorAnioAsync(anioSeleccionado);

            await Task.WhenAll(reporteTask, facturasTask);

            datosReporte = await reporteTask;
            facturasDelAnio = await facturasTask;

            if (datosReporte != null && datosReporte.Any())
            {
                totalAnual = datosReporte.Sum(item => item.TotalMes);
            }
        }
        catch (Exception ex)
        {
            mensajeError = $"Error al generar el reporte: {ex.Message}";
        }
    }
}